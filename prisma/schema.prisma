// HR Management System - Prisma Schema
// Face Recognition Attendance System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum Gender {
  male
  female
  other
}

enum ContractType {
  full_time
  part_time
  contract
  internship
}

enum EmploymentStatus {
  active
  on_leave
  terminated
  resigned
}

enum UserRole {
  admin
  hr_manager
  department_manager
  employee
}

enum AttendanceStatus {
  present
  absent
  late
  early_leave
  on_leave
  holiday
}

enum LeaveType {
  annual
  sick
  unpaid
  maternity
  paternity
  personal
}

enum LeaveStatus {
  pending
  approved
  rejected
  cancelled
}

enum DeviceType {
  fingerprint
  face_recognition
  mobile_app
}

enum VerificationMethod {
  face_recognition
  manual
}

enum AssignmentStatus {
  assigned
  returned
  lost
  damaged
}

// ==================== MODELS ====================

model Department {
  id          Int          @id @default(autoincrement())
  code        String       @unique
  name        String
  description String?
  managerId   Int?         @map("manager_id")
  parentId    Int?         @map("parent_id")
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  employees   Employee[]
  shifts      Shift[]
  parent      Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children    Department[] @relation("DepartmentHierarchy")

  @@map("departments")
}

model Employee {
  id              Int              @id @default(autoincrement())
  employeeCode    String           @unique @map("employee_code")
  firstName       String           @map("first_name")
  lastName        String           @map("last_name")
  fullName        String           @map("full_name")
  email           String?          @unique
  phoneNumber     String?          @map("phone_number")
  birthDate       DateTime?        @map("birth_date") @db.Date
  gender          Gender?
  address         String?
  avatarUrl       String?          @map("avatar_url")
  avatarPublicId  String?          @map("avatar_public_id")

  // Face Recognition Data
  faceDescriptor    Json?          @map("face_descriptor")
  facePhotoUrl      String?        @map("face_photo_url")
  facePhotoPublicId String?        @map("face_photo_public_id")
  faceRegisteredAt  DateTime?      @map("face_registered_at")

  // Employment Info
  hireDate         DateTime        @map("hire_date") @db.Date
  contractType     ContractType    @map("contract_type")
  contractEndDate  DateTime?       @map("contract_end_date") @db.Date
  position         String
  departmentId     Int             @map("department_id")
  managerId        Int?            @map("manager_id")

  // Status
  employmentStatus EmploymentStatus @default(active) @map("employment_status")
  isActive         Boolean          @default(true) @map("is_active")

  // Timestamps
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  department         Department         @relation(fields: [departmentId], references: [id])
  manager            Employee?          @relation("EmployeeManager", fields: [managerId], references: [id])
  subordinates       Employee[]         @relation("EmployeeManager")
  user               User?
  attendances        Attendance[]
  leaves             Leave[]
  employeeShifts     EmployeeShift[]
  deviceAssignments  DeviceAssignment[]

  @@map("employees")
}

model User {
  id            Int       @id @default(autoincrement())
  username      String    @unique
  passwordHash  String    @map("password_hash")
  role          UserRole
  employeeId    Int?      @unique @map("employee_id")
  isActive      Boolean   @default(true) @map("is_active")
  lastLogin     DateTime? @map("last_login")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  employee      Employee? @relation(fields: [employeeId], references: [id])
  leaveApprovals Leave[]  @relation("LeaveApprover")

  @@map("users")
}

model Shift {
  id                    Int       @id @default(autoincrement())
  name                  String
  code                  String    @unique
  departmentId          Int?      @map("department_id")

  // Time
  startTime             String    @map("start_time") // Store as HH:mm format
  endTime               String    @map("end_time")
  breakDuration         Int       @map("break_duration") // minutes

  // Working days (array of day numbers: 0=Sunday, 1=Monday, etc.)
  workingDays           Int[]     @map("working_days")

  // Grace periods
  lateGracePeriod       Int       @default(15) @map("late_grace_period") // minutes
  earlyLeaveGracePeriod Int       @default(15) @map("early_leave_grace_period")

  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  department    Department?      @relation(fields: [departmentId], references: [id])
  attendances   Attendance[]
  employeeShifts EmployeeShift[]

  @@map("shifts")
}

model EmployeeShift {
  id            Int       @id @default(autoincrement())
  employeeId    Int       @map("employee_id")
  shiftId       Int       @map("shift_id")
  effectiveFrom DateTime  @map("effective_from") @db.Date
  effectiveTo   DateTime? @map("effective_to") @db.Date
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  shift    Shift    @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@unique([employeeId, shiftId, effectiveFrom])
  @@map("employee_shifts")
}

model Attendance {
  id            Int              @id @default(autoincrement())
  employeeId    Int              @map("employee_id")
  date          DateTime         @db.Date
  shiftId       Int?             @map("shift_id")

  // Check in/out times
  checkInTime   DateTime?        @map("check_in_time")
  checkOutTime  DateTime?        @map("check_out_time")

  // Status
  status        AttendanceStatus @default(present)
  isLate        Boolean          @default(false) @map("is_late")
  isEarlyLeave  Boolean          @default(false) @map("is_early_leave")

  // Working hours
  workingHours  Decimal?         @map("working_hours") @db.Decimal(5,2)
  overtimeHours Decimal?         @map("overtime_hours") @db.Decimal(5,2)

  // Face Recognition Check-in
  checkInPhotoUrl       String?            @map("check_in_photo_url")
  checkInPhotoPublicId  String?            @map("check_in_photo_public_id")
  checkInLocation       String?            @map("check_in_location") // "lat,lng"
  checkInAddress        String?            @map("check_in_address")
  checkInConfidence     Decimal?           @map("check_in_confidence") @db.Decimal(5,2)
  checkInMethod         VerificationMethod @default(face_recognition) @map("check_in_method")

  // Face Recognition Check-out
  checkOutPhotoUrl      String?            @map("check_out_photo_url")
  checkOutPhotoPublicId String?            @map("check_out_photo_public_id")
  checkOutLocation      String?            @map("check_out_location")
  checkOutAddress       String?            @map("check_out_address")
  checkOutConfidence    Decimal?           @map("check_out_confidence") @db.Decimal(5,2)
  checkOutMethod        VerificationMethod @default(face_recognition) @map("check_out_method")

  // Device tracking
  deviceId      Int?             @map("device_id")

  // Manual marking
  note          String?
  markedBy      Int?             @map("marked_by")
  markedAt      DateTime?        @map("marked_at")

  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])
  shift    Shift?   @relation(fields: [shiftId], references: [id])
  device   Device?  @relation(fields: [deviceId], references: [id])

  @@unique([employeeId, date])
  @@index([date])
  @@index([status])
  @@map("attendances")
}

model Leave {
  id              Int         @id @default(autoincrement())
  employeeId      Int         @map("employee_id")
  leaveType       LeaveType   @map("leave_type")
  startDate       DateTime    @map("start_date") @db.Date
  endDate         DateTime    @map("end_date") @db.Date
  totalDays       Decimal     @map("total_days") @db.Decimal(4,1)
  reason          String
  status          LeaveStatus @default(pending)

  // Approval
  approvedBy      Int?        @map("approved_by")
  approvedAt      DateTime?   @map("approved_at")
  rejectedReason  String?     @map("rejected_reason")

  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])
  approver User?    @relation("LeaveApprover", fields: [approvedBy], references: [id])

  @@index([employeeId, status])
  @@index([startDate, endDate])
  @@map("leaves")
}

model Device {
  id            Int        @id @default(autoincrement())
  deviceCode    String     @unique @map("device_code")
  deviceName    String     @map("device_name")
  deviceType    DeviceType @map("device_type")
  location      String?
  ipAddress     String?    @map("ip_address")
  specs         Json?      // Camera specs, capabilities
  isActive      Boolean    @default(true) @map("is_active")
  lastSync      DateTime?  @map("last_sync")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  attendances  Attendance[]
  assignments  DeviceAssignment[]

  @@map("devices")
}

model DeviceAssignment {
  id           Int              @id @default(autoincrement())
  employeeId   Int              @map("employee_id")
  deviceId     Int              @map("device_id")
  assignedDate DateTime         @map("assigned_date") @db.Date
  returnDate   DateTime?        @map("return_date") @db.Date
  status       AssignmentStatus @default(assigned)
  note         String?
  createdAt    DateTime         @default(now()) @map("created_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])
  device   Device   @relation(fields: [deviceId], references: [id])

  @@map("device_assignments")
}
